<!DOCTYPE html>
{% load to_replace %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Document</title>
</head>
<body>
<style>
    .form-rounded {
        border-radius: 0.7rem;
    }
    .label-text {
        font-size: 0.8em;
    }
    .offer-text {
        font-size: 0.7em;
    }

    #win_respond {
            background-color: #E6F1DA;
    }
    .responds-block {
            border-radius: 20px;
    }
    .responds-img {
            width: 8em;
            height: 10em;
    }
    .form-img {
            width: 3em;
            height: 4em;
    }
    .remove-foto {
            text-decoration: none;
            font-size: 0.8em;
    }
</style>

    <div class="container mt-3">
        <h5>Отклик к заданию {{ order.set_numb_of_order }}</h5>
        <hr>
        <!--Экранирование html-->
        {% autoescape off %}
        <p>{{ order.note|to_replace }}</p>
        {% endautoescape %}

        <p><small class="text-muted">Количество откликов:</small> {{ amount_responds }} из {{ order.max_responds }}<br>
        <small class="text-muted">Стоимость отклика:</small> {{ order.respond_price }} руб.<br>
        <small class="text-muted">Мой баланс:</small> {{ staff.balance }} руб. <a href="#"><small>(пополнить)</small></a></p>
        <hr>

        <!-- Проверка что у него нет отклика  -->

        {% if amount_responds < order.max_responds and respond == None %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label class="text-muted label-text" for="message">Текст отклика:</label>
                <textarea class="form-control form-control-sm form-rounded" id="message" name="message" rows="3"></textarea>
            </div>
            <div class="form-group my-2">
                <div class="row">
                    <div class="col-6">
                        <label class="text-muted label-text" for="instagram">Мой Instagram:</label>
                        <input type="text" class="form-control form-control-sm" id="instagram" name="instagram" value="@{{ staff.instagram }}" disabled>
                    </div>
                    <div class="col-6">
                        <label class="text-muted label-text" for="whatsapp">Мой Whatsapp:</label>
                        <input type="text" class="form-control form-control-sm" id="whatsapp" name="whatsapp" value="+{{ staff.phone }}" disabled>
                    </div>
                </div>
            </div>
            <div class="form-group my-2">
                <label class="text-muted label-text" for="images">Фото работ</label>
                <input type="file" class="form-control form-control-sm" id="images" name="images" multiple>
            </div>
            <div class="form-group my-2">
                <div class="row">
                    <div class="col-6">
                        <label class="text-muted label-text" for="price">Цена:</label>
                        <input type="text" class="form-control form-control-sm" id="price" name="price">
                    </div>
                    <div class="col-6">
                         <label class="text-muted label-text" for="pin">pin</label>
                         <input type="text" class="form-control form-control-sm" id="pin" name="pin">
                    </div>
                </div>
            </div>
            {% if has_balance %}
            <div class="d-grid gap-2 mt-2">
                <small class="offer-text text-muted">Нажимая кнопку "Откликнуться" с баланса будут списаны {{ order.respond_price }} руб. и отклик с вашими контактными данными будет отправлен заказчику. Закачик свяжется с вами, если ваш отклик его заинтересует.</small>
                <input class="btn btn-success btn-md form-rounded" type="submit" value="Откликнуться">
            </div>
            {% else %}
            <div class="d-grid gap-2 mt-2">
                <small class="offer-text text-muted">Для того, чтобы отправить свой отклик клиенту с вашими контактными данными требуется пополнить баланс. Для отклика требуется {{ order.respond_price }} руб., а ваш баланс равен {{ staff.balance }} руб..</small>
                <button class="btn btn-danger btn-md form-rounded" disabled>Пополните баланс</button>
            </div>
            {% endif %}
        </form>

        {% elif respond %}
        <p>Вы уже оставили отклик:</p>
        <div id="win_respond" class="border border-1 responds-block mb-3">

            <div class="container p-3">
                <small><b>{{ respond.text }}</b></small><br>
                <small>Стоимость: {{ respond.price }} руб.</small><br>
                <hr>
                <small class="text-muted">Instagram: <a href="https://instagram.com/{{ respond.staff.instagram }}">instagram.com/{{ respond.staff.username }}</a></small><br>
                <small class="text-muted">WhatsApp: <a href="https://wa.me/{{ respond.staff.phone }}">+{{ respond.staff.phone }}</a></small><br>
                <div class="container mt-3">
                    <div class="row">
                        {% for image in respond.images.all %}
                        <div class="col-lg-3 col-md-4 col-6 my-2 text-center">
                            <img src="{{ image.image.url }}" class="image-fluid rounded responds-img" alt="...">
                        </div>
                        {% endfor %}
                    </div>
                </div>
                    <div class="text-center">
                        <small><a href="#" data-bs-toggle="modal" data-bs-target="#editRespond">Редактировать отклик</a></small>
                    </div>
                </div>
            </div>

            <!-- МОДАЛЬНОЕ ОКНО  -->
            <div class="modal fade" id="editRespond" tabindex="-1" aria-labelledby="ModalLabel3" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel3">Редактировать отклик</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="text-muted label-text" for="message2">Текст отклика:</label>
                            <textarea class="form-control form-control-sm form-rounded" id="message2" name="message" rows="3">{{ respond.text }}</textarea>
                        </div>
                        <small class="label-text text-muted mt-3">Удалить фото:</small>
                          <div class="row">
                            {% for image in respond.images.all %}
                            <div id="{{ image.id }}" class="col-2 my-2 text-center">
                                <img src="{{ image.image.url }}" class="image-fluid rounded form-img" alt="..."><br>
                                <a data-id="{{ image.id }}" class="remove-foto" href="#">x</a>
                            </div>
                            {% endfor %}
                    </div>

                        <div class="form-group my-2">
                            <label class="text-muted label-text" for="images2">Добавить фото:</label>
                            <input type="file" class="form-control form-control-sm" id="images2" name="images" multiple>
                        </div>
                        <div class="form-group my-2">
                            <div class="row">
                                <div class="col-6">
                                    <label class="text-muted label-text" for="price2">Цена:</label>
                                    <input type="text" class="form-control form-control-sm" id="price2" name="price" value="{{ respond.price }}">
                                </div>
                                <div class="col-6">
                                     <label class="text-muted label-text" for="pin2">pin</label>
                                     <input type="text" class="form-control form-control-sm" id="pin2" name="pin">
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 my-3">
                            <input id="change" class="btn btn-success btn-md form-rounded" type="submit" value="Редактировать">
                        </div>
                      </form>
                  </div>
                </div>
              </div>
            </div>

        {% elif amount_responds >= order.max_responds %}
        <p>К сожалению, отклик к этому заданию больше нельзя оставить, так как превышено максимальное количество откликов.<br>
        Если потребуются дополнительные отклики, вам придет уведомление.</p>

        {% endif %}

    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script
  src="https://code.jquery.com/jquery-3.6.0.js"
  integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
  crossorigin="anonymous"></script>
<script>
<!--$(document).ready(function(){-->
<!--          $(".remove-foto").on("click", function(e) {-->
<!--                e.preventDefault();-->
<!--                var dataId = $(this).attr("data-id")-->
<!--                $.ajax({-->
<!--                    type: "POST",-->
<!--                    url: "/delete/foto",-->
<!--                    data: {-->
<!--                        id: dataId,-->
<!--                        csrfmiddlewaretoken: '{{ csrf_token }}'-->
<!--                    },-->
<!--                    success: function(result) {-->
<!--                        $(`#${dataId}`).css("display", "none");-->
<!--                        console.log('Foto delete');-->
<!--                    },-->
<!--                    error: function(result) {-->
<!--                        console.log('error');-->
<!--                    }-->
<!--                });-->
<!--            });-->
<!--});-->


$(document).ready(function(){
          var images = []
          $(".remove-foto").on("click", function(e) {
                e.preventDefault();
                var dataId = $(this).attr("data-id")
                images.push(dataId);
                $(`#${dataId}`).css("display", "none");
                console.log(images);
            });
          $("#change").on("click", function(e) {
                $.ajax({
                    type: "POST",
                    url: "/delete/foto",
                    data: {
                        ids: images,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(result) {
                        console.log('Foto delete');
                    },
                    error: function(result) {
                        console.log('error');
                    }
                });
            });
});


</script>
</html>